<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>How to port user kernels to Kokkos &mdash; VPIC-Kokkos 2.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Postprocessing and Visualization" href="vis.html" />
    <link rel="prev" title="Running VPIC" href="run.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> VPIC-Kokkos
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="comp.html">Compiling VPIC</a></li>
<li class="toctree-l1"><a class="reference internal" href="run.html">Running VPIC</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">How to port user kernels to Kokkos</a></li>
<li class="toctree-l1"><a class="reference internal" href="vis.html">Postprocessing and Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="pbd.html">Particle Boundary Diagnostic</a></li>
<li class="toctree-l1"><a class="reference internal" href="issues.html">Known Issues</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">VPIC-Kokkos</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>How to port user kernels to Kokkos</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/porting.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="how-to-port-user-kernels-to-kokkos">
<h1>How to port user kernels to Kokkos<a class="headerlink" href="#how-to-port-user-kernels-to-kokkos" title="Permalink to this headline">ÔÉÅ</a></h1>
<p>Most user code/loops can be easily converted to run on the GPU, as long as we follow
some simple rules:</p>
<ol class="arabic simple">
<li><p>The code must be safe to run in parallel (there is no [sane] way to run serial on the GPU). A kokkos scatter view can be used to generate atomics and handle data races. See <cite>advance_p</cite> for an example.</p></li>
<li><p>The ported loop <em>cannot</em> call code that dereferences pointers. This is because the lambdas capture all variables by values, meaning the code will capture the pointer value from CPU space, and try use it in GPU space. This is often the source of pretty tricky bugs, as it may work on CPU but not GPU. An example of #2 above is something like calling the function <cite>voxel()</cite> in a field loop to convert from 2/3D. The function voxel calls <cite>grid-&gt;sz</cite> internally. We need to capture dereferenced pointer variables in a local variable above the lambdas</p></li>
</ol>
<p>An example of porting a user defined field injection is included below:</p>
<p>Original::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">for</span> <span class="p">(</span> <span class="nb">int</span> <span class="n">iz</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">iz</span><span class="o">&lt;=</span><span class="n">grid</span><span class="o">-&gt;</span><span class="n">nz</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">iz</span> <span class="p">)</span>
      <span class="k">for</span> <span class="p">(</span> <span class="nb">int</span> <span class="n">iy</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">iy</span><span class="o">&lt;=</span><span class="n">grid</span><span class="o">-&gt;</span><span class="n">ny</span><span class="p">;</span> <span class="o">++</span><span class="n">iy</span> <span class="p">)</span>
        <span class="n">field</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">iz</span><span class="p">)</span><span class="o">.</span><span class="n">ey</span> <span class="o">+=</span> <span class="n">prefactor</span>
                             <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">PHASE</span><span class="p">)</span>
<span class="o">//</span>                           <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">R2</span><span class="o">/</span><span class="p">(</span><span class="k">global</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="k">global</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">))</span>  <span class="o">//</span> <span class="mi">3</span><span class="n">D</span>
                             <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">R2Z</span><span class="o">/</span><span class="p">(</span><span class="k">global</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="k">global</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">))</span>
                             <span class="o">*</span> <span class="n">MASK</span> <span class="o">*</span> <span class="n">pulse_shape_factor</span><span class="p">;</span>
</pre></div>
</div>
<p>Modified::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>int _sy = grid-&gt;sy; // safe to dereference grid outside of the loop
int _sz = grid-&gt;sz;
// Complex, fast, multiple dimension loop
Kokkos::MDRangePolicy&lt;Kokkos::Rank&lt;2&gt;&gt; left_edge({1, 1}, {nz+2, ny+1});
Kokkos::parallel_for(&quot;Field injection&quot;, left_edge, KOKKOS_LAMBDA(const int iz, const int iy) {
    auto DY   =( y0 + (iy-0.5)*dy - ycenter );
    auto DZ   =( z0 + (iz-1  )*dz - zcenter );
    auto R2   =( DY*DY + DZ*DZ );
    auto R2Z  = ( DZ*DZ );
    auto PHASE=( -omega_0*t + h*R2Z/(width*width) );
    auto MASK =( R2Z&lt;=pow(mask*width,2) ? 1 : 0 );
    // We want to call the function voxel(1,iy,iz) (from vpic.h, not the
    //   macro) but that would cause an illegal defeference of grid!
    //   Instead we can use local variables, or use static functions.
    int vox = ix + _sy*iy + _sz*iz; // locally captured above
    kfield(vox, field_var::ey) += prefactor
                                 * cos(PHASE)
                                 * exp(-R2Z/(width*width))
                                 * MASK * pulse_shape_factor;
});
</pre></div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="run.html" class="btn btn-neutral float-left" title="Running VPIC" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="vis.html" class="btn btn-neutral float-right" title="Postprocessing and Visualization" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Los Alamos National Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>